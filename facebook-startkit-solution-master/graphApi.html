<!DOCTYPE html>
<html>
     <head>
          <meta charset="UTF-8">
          <title>Facebook api</title>						
          <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
          <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
          <link rel="stylesheet" href="css/reset.css">	
          <link rel="stylesheet" href="css/main.css">
          <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
          <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
		  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.2.min.js"></script>

	</head>
	<body>
		<div
  class="fb-like"
  data-share="true"
  data-width="450"
  data-show-faces="true">
</div>
	    <header><p class="notLogin">未登入</p><button id="logoutBtn" class="btn btn-danger">登出</button></header>	
	    <article>
			<div id="indexView">
			   <div id="fbImgView"></div>
			   <div id="container">
				    <div class="row">

				      你好<span id="name"></span>
				      <!-- <a href="logIn.html" class="btn">登入</a>
				      <a href="signUp.html" class="btn">註冊</a> -->
				    </div>

				    <div class="row">
				      <h2>留言板</h2>

				      <!-- 這一部分要大家去 form builder 做 -->
				      <!-- http://bootsnipp.com/forms?version=3 -->
				      <blockquote>
				        <form id="commentForm" class="form-horizontal">
				          <div class="form-group">
				            <div class="col-md-4">
				              <textarea class="form-control" placeholder="請輸入留言" id="comment" name="comment"></textarea>
				            </div>
				          </div>
				          <!-- Practice 5 儲存圖片 -->
				          <div class="form-group">
				            <div class="col-md-4"><input type="file" id="fileInput"></div>
				          </div>

				          <div class="form-group">
				            <div class="col-md-4"><button id="commentSubmit" name="commentSubmit" class="btn btn-primary">送出</button></div>
				          </div>
				        </form>
				      </blockquote>
				      <div id="comments">
				        <blockquote>
				          <p>助教: 今天天氣不錯</p>
				        </blockquote>
				      </div>
				    </div>
				  </div>
		    </div>
	    	<form id="loginView">
				  <label>username:<input class="form-control" id="username" type="text" placeholder="請輸入使用者名稱..."></label>
				  <label>password:<input class="form-control" id="password" type="password" placeholder="請輸入密碼..."></label>
				  <button id="loginBtn" class="btn btn-success" type="submit">登入</button>
				  <button id="signupBtn" class="btn btn-info" type="submit">註冊</button>
				  <button id="fbloginBtn" class="btn btn-primary" type="submit">臉書登入</button>
			</form>
	    </article>	
		
	<script>
	
		//step1:https://www.parse.com/docs/js/guide#users-facebook-users
		
        // Initialize Parse
        Parse.initialize("Avp2LWPc7XR8vau5shMlzGx6RZD3iyCJMz2CPvPO", "Ajfie2Q3dh4CUnEtbrLwBttD1YvVlDHPiAcBC75w");


        window.fbAsyncInit = function() {
      Parse.FacebookUtils.init({
      appId      : '1652401031642744',
	  status : true, // check Facebook Login status
	  cookie : true, // enable cookies to allow Parse to access the session
	  xfbml : true, // initialize Facebook social plugins on the page
	  version : 'v2.3' // point to the latest Facebook Graph API version
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

		function fblogin(){
		    //step2:https://developers.facebook.com/docs/graph-api/using-graph-api/v2.3	
			
			Parse.FacebookUtils.logIn(null, {
			  success: function(user) {
			    if (!user.existed()) {
			      alert("註冊完成並且透過臉書登入");
			    } else {
			      alert("透過臉書登入成功");
			    }
				indexView();//切換至預先寫好登入後的介面
				FB.getLoginStatus(function(response) {
				     if (response.status === 'connected') {
				         FB.api('/me/picture?type=large', function (response) {
						    $('#fbImgView').html("<h5>Here are your profile photo</h5><img src="+response.data.url+" crossorigin=\"anonymous\" id=preview1 />");          
				         });
						 
				         FB.api('/me', function (response) {
							 console.log(response);
							 $('#fbImgView').append("<h1>Welcome , "+(response['gender']=="male"?"Mr. ":"Miss ")+" "+response['first_name']+"</h1>");
				         });
						
				     }
			     }); 
			  },
			  error: function(user, error) {
			    alert("使用者取消登入或沒有授權");
			  }
			});
		}
		if (!Parse.User.current()){
      alert("你尚未登入");
      window.location = "logIn.html";
    }

    $(document).ready(function(){
      console.log(Parse.User.current());
      if (Parse.User.current()){
        $("#name").text(Parse.User.current().get("username"));
      }
      

      // Practice 2  這裏要補充兩行不見的程式碼
       var Comment = Parse.Object.extend("Comment") ;
       var queryComments = new Parse.Query (Comment) ;

      // Practice 3  要將關聯的資料也一起抓下來
      queryComments.include("targetUser") ; // 在 query 時必須要 include 該欄位，才會抓取該欄位的資料
      // Practice 4  只顯示目前使用者的留言
    
      // Practice 6  只抓取有圖片的留言
      //queryComments.exists("img");
      queryComments.find({
        success : function(arrayOfQueriedObjects){
          console.log (arrayOfQueriedObjects);
    
          for (var i = 0 ; i < arrayOfQueriedObjects.length ; i++){
            comment = arrayOfQueriedObjects[i] ;
    
            $("#comments").append(
              "<blockquote>"+
                comment.get("targetUser").get("username") + ": " +comment.get("message")+
                // "<br><img src='"+ comment.get("img").url()+"' height='100px'>"+  // Practice 6
              "</blockquote>");
          }
        },
        error : function(errorObject){
          alert(errorObject.message) ;
        }
      });
    });

    $(document).on('submit','#commentForm',function(eventObject){
      eventObject.preventDefault();

      var Comment = Parse.Object.extend("Comment") ;
      var comment = new Comment();

      comment.set("message",$("#comment").val());
      // Practice 1 記錄發文的使用者
      comment.set("targetUser", Parse.User.current()) ;
      // Practice 5 儲存圖片
      if ($("#fileInput")[0].files.length > 0) {
       var file = $("#fileInput")[0].files[0];
       var name = "photo";
       var parseImg = new Parse.File(name, file);
       comment.set("img",parseImg);
       parseImg.save({
       success : function (savedImg){
       alert(savedImg.url());
       },
       error : function (saveingImg , errorObject){
       alert(errorObject.message) ;
       }
       });
      }
      comment.save({
        success : function(savedParseObject){
          alert("留言成功");
          window.location.reload();
        },
        error : function (errorObject){
          console.log(errorObject);
          alert(errorObject.message);
        }
      });
    });
	</script>
    <script src="js/graphApi.js"></script>		   	
    </body>
</html>